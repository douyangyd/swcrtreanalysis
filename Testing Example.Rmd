---
title: "An example of using the code to analyze a standardized dataset - Harding_30336784"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

### Make sure you have all the packages installed before continue
```{r, eval= F}
install.packages("sandwich")
install.packages("clubSandwich")
install.packages("WoodburyMatrix")
install.packages("dplyr")
install.packages("msm")
install.packages("lmerTest")
install.packages("splines")
install.packages("performance")
install.packages("stringr")
```

# Load all functions

-   vcovCRglmerMod.R is the robust variance estimator function for glmer
-   fit_binary_CS.R: fit binary outcome data with cross-section (CS) design
-   fit_binary_CO.R: fit binary outcome data with cohort (CO) design
-   fit_gaussian_CS.R: fit gaussian outcome data with cross-section (CS) design
-   fit_gaussian_CO.R: fit gaussian outcome data with cohort (CO) design
-   fit_poisson_CS.R: fit poisson outcome data with cross-section (CS) design
-   fit_poisson_CO.R: fit poisson outcome data with cohort (CO) design

```{r, warning = FALSE, message=FALSE}
source("vcovCRglmerMod.R")
source("fit_binary_CS.R")
source("fit_binary_CO.R")
source("fit_gaussian_CS.R")
source("fit_gaussian_CO.R")
source("fit_poisson_CS.R")
source("fit_poisson_CO.R")
```

# Load the standardized dataset

```{r}
# Harding_30336784: 2 poisson (no offset) and 1 binary, CS
# for now the loaded data has to be named as "data" in order to make the data processing automated
data <- read.csv("C:/Users/yongdong ouyang/Downloads/Harding_30336784.csv")
head(data)
```

# Load the data_processing file to handle the imported dataset.

This function will do the following things:

-   Format the standardized dataset: Return a list of datasets, with the number of datasets equals to the number of outcomes. Each dataset in the list will contain one specific outcome along with all the necessary variables for model fitting. For example, if we have three outcomes, this function will return a list of 3 datasets named as **data**. Each dataset contains one outcome with all other varibles we need for regression (e.g., cluster id, treatment indicator, exposure indicator etc)
-   Provide some summary information, such as total number of outcomes, number of outcomes for each type

```{r, warning = FALSE, message=FALSE}
source("Data_processing.R")

# check some summaries

# names and number of outcome columns (this gives us ideas about the outcome types)
outcome_columns # "out_poiss_1" "out_poiss_2" "out_bin_1"  
length(outcome_columns) # 3

# Since there are poisson outcomes run the following code to see if there are offset columns
# ignore it if we don't have poisson outcomes
offset_columns # character(0)


# We can further check how many continuous, binary or poisson outcomes we have:
length(gaussian_columns) #0
length(binary_columns) #1
length(poisson_columns) #2

# Check if we have individual ID column (a indicator whether we have CO or CS design)
length(ind_columns) # 0



```

# Upto here, we can quickly summarize that the Harding dataset has three outcomes (2 Poisson and 1 Binary), CS design, no offset for Poisson outcomes

Have a quick look of the processed dataset. Since we have three outcomes in total, the length of the data list is 3.

```{r}
# check the processed datasets
length(data) # 3
head(data[[1]]) # Outcome column is out_poiss_1
head(data[[2]]) # Outcome column is out_poiss_2
head(data[[3]]) # Outcome column is out_bin_1
```

# Model fiting
#### For out_poiss_1 (this is the first element of the data list)
```{r, cache=TRUE}
test1 <- fit.data.poisson.CS(data = data[[1]], rve_type = "classic", ss_correct = T, offset = NULL)
names(test1)
names(test1$IT)
names(test1$ETI)
names(test1$NCS)
names(test1$TEH)
names(test1$convergence)
test1$convergence
```

The outputs (e.g., test1) contains the following items:

-   test1 is list contains following items:
    -   **IT**: information about immediate treatment effect model
    -   **ETI**: information about exposure time indicator model
    -   **NCS**: information about natural cubic spline model
    -   **TEH**: information about treatment heterogeneity exposure time model
    -   **convergence**: information about which model was converged, following most complicated to least complicated (for TEH model, the random effect for exposure time is always in the model)
      - model 1: 
        - random intercept + random cluster-period + random individual effect (for a CO design)
        - random intercept + random cluster-period (for a CS design)
      - model 2: 
        - random intercept + random cluster-period (for a CO design)
        - random intercept (for a CS design)
      - model 3:
        - random intercept (for a CO design)
        - NA for CS design

-   Within each model information we have:
    -   **est**: estimation table include the fixed effect estimates, SE, p-value etcs
    -   **vcov**: variance-covariance matrix
    -   **rve**: variance-covariance matrix with RVE
    -   **summary**: average treatment effect estimates, SE and CI with/without RVE (CIs have (or do not have small sample corrections based on the input of "ss_correct"))

#### out_poiss_2 (this is the second element of the data list)
```{r, cache=TRUE}
test2 <- fit.data.poisson.CS(data = data[[2]], rve_type = "classic", ss_correct = T, offset = NULL)
```


#### out_bin_1 (this is the third element of the data list)
```{r, cache=TRUE}
test3 <- fit.data.binary.CS(data = data[[3]], rve_type = "classic", ss_correct = T)
```

Sometimes, none of the models we tried under a specific type were converged. For example, here all models we tried under ETI and NCS models did not converge. In this case, nothing will be returned.

```{r}
test3$ETI
test3$NCS
```

